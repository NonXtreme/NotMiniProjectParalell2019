<script>
	$("#enterUsernameModal").modal()
	var socket = io('ws://10.202.237.14:8001/');  //must be considered again
	var userID = null
    var groupID = null
    var joinedGroup = []
    var groupJoinedStatus = {}
    var ack = {}
    var chat = {}
    var unreadCount = {}
    setInterval(updateGroupList,1000)
    setInterval(updateGroupChat,300)
    socket.on('connect', (e) => {
      console.log("Connection successful");
      $("#statusSpan").html("CONNECTED");
    })


    function displayGroups(){
      $('#groupListResult').empty()
      $.each(groupJoinedStatus, function(key, value) {
       if(value === true)  //for joined groups
       {
          $('#groupListResult').append(`<div><span style="cursor:pointer; border:1px solid black; padding:5px; margin:5px;" onclick="selectGroup('${key}')">${key}(${unreadCount[key]})<span>
             <span style="cursor:pointer;" class="float-right" onclick="leaveGroup('${key}')">Leave Group</span>
           	 </div>`)
       }
       else  //for non-joined groups
       {
          $('#groupListResult').append(`<div style="cursor:pointer; border:1px solid black; padding:5px; margin:5px;" onclick="requestJoinGroup('${key}')">${key}</div>`)
       } 
      });
    }
     
    function updateGroupList(){
    	if(username===null) return
    	
    	socket.emit('request', {
        action:'getAllGroup',
      },x=>{
        console.log(x)
        x.result.map(y=>y['group_id']).forEach(y=>{
        groupJoinedStatus[y] = false
        })
      });
       
        socket.emit('request', {
        action:'getJoinedGroup',
        userID: userID,
      },x=>{
        console.log(x)
        $('#myGroupResult').empty()
        joinedGroup = x.result.map(y=>y['group_id'])
        joinedGroup.forEach(y=>{
          if(unreadCount[y] === undefined){
            unreadCount[y] = 0
          }
          groupJoinedStatus[y] = true
        })
      });
        displayGroups()
    }


    function render(y) //generate messages
    {
      let d = new Date(y.message_timestamp)
      $('#chatArea').append(`<div class="${y.message_sender==username?'my':'your'}">
          <span class="username" style="font-weight:900">${y.message_sender} &nbsp;</span> <span class="message">${y.message_text}</span> <span class="timestamp">${d.toLocaleTimeString()}</span>
        </div>`)
      $('#chatArea').animate({scrollTop: 999999999999999},30)
    }

    function updateGroupChat(){
      if(username===null)return
      joinedGroup.forEach(gid_=>{
        let gid = gid_
        if(ack[gid] === undefined) ack[gid]=-1
        socket.emit('request', {
          action:'getGroupChat',
          groupID: gid,
          ack: ack[gid]
        },x=>{
          if(chat[gid] === undefined) chat[gid]=[]
          console.log(x)
          x.result.forEach(y=>{
            if(y.message_id <= ack[gid]) return
            chat[gid].push(y)  
            ack[gid]= y.message_id
            if(gid === groupID) render(y)
            else
            {
              unreadCount[gid]++;
            }
          })
        })
      })
    }

    function createGroup(){
      let name=$('#groupNameField').val()
      socket.emit('request', {
        action:'createGroup',
        groupID: name,
        userID: userID
      },x=>{
        console.log(x)
      });
      updateGroupList()
      selectGroup(gid)
    }
    
    function selectGroup(gid){
      groupID = gid
      $('#chatArea').html('')
      chat[gid].forEach(x=>render(x))
      $('#groupNameResult').html(gid)
      unreadCount[gid] = 0;
    }
    
    function requestJoinGroup(gid)
    {
       $('#groupNameResult').html('Join Group ?')
       $('#chatArea').html('<div class="d-flex flex-column justify-content-center align-items-center h-100"><button class="btn btn-info btn-block" style="margin-top:10px; border:none !important; background-color:#BE7DB7!important;" onclick="joinGroup(gid)">Join!</button></div>')
    }

    function joinGroup(gid){
      socket.emit('request', {
        action:'joinGroup',
        userID: userID,
        groupID: gid
      },x=>{
        console.log(x)
        ack[gid] = -1
        chat[gid] = []
        unreadCount[gid]= 0
      });
      updateGroupList()
      selectGroup(gid)
    }

    function leaveGroup(gid){
      socket.emit('request', {
        action:'leaveGroup',
        userID: userID,
        groupID: gid
      },x=>{
        console.log(x)
        groupID = null

        $('#groupNameResult').html('-')
        $('#chatArea').html(`<div class="d-flex flex-column justify-content-center align-items-center h-100">
              <div style="font-size: 20em; color: #231C3B; font-size: 1.6em;">Select one of the groups from the list</div>
            </div>`)
      });
    }

    function sendMessage(){
      let message=$('#messageField').val()
      if(message.length == 0) return;
      socket.emit('request', {
        action:'sendMessage',
        userID: userID,
        message: message,
        groupID: groupID
      },x=>{
        console.log(x)
        $('#messageField').val('')
      });
    }

    function login() {
      userID = $("#usernameField").val();
      $("#usernameSpan").html(userID);
      socket.emit('request', {
        action:'login',
        userID: userID,
      },x=>{
        console.log(x)
      });
    }

 </script>